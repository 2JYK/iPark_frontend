<!DOCTYPE html>
<html lang="ko">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Login</title>
    </head>

    <body>
        <form:form commandName="memberV0" id="mfm" name="mfm" method="post">
            <input type="hidden" name="email" value="" />
        </form:form>
        <button class="btn-icon" onclick="kakaoLogin();">
            <img src="./static/css/image/kakao_login.png" alt="카카오톡">
        </button>
        <a href="#0" id="kakaoLogout" onclick="kakaoLogout();">로그아웃</a>
        <a href="#0" id="disconnect" onclick="disconnect();">탈퇴</a>


        <!-- 카카오톡 로그인 -->
        <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
        <script>        
            // 로그인 //
            function kakaoLogin(){
                if(Kakao.isInitialized() == false){
                    Kakao.init("c414e5945e36386b3b383a30f1b31271");}

                Kakao.Auth.login({
                    success : function(authObj){
                        console.log("authObj", authObj)
                        Kakao.API.request({
                            url : "/v2/user/me",
                            success : function(response){
                                console.log("성공", response);
                                var username = response.kakao_account.email.split("@")[0];
                                var email = response.kakao_account.email;
                                sendLoggedInData(username, email, "kakao");
                            },
                            fail : function(error){
                                console.log("실패", error);
                                if (!Kakao.Auth.getAccessToken()){
                                    alert("로그인상태가 아닙니다")
                                    return
                                }
                                Kakao.Auth.logout(function(){
                                    alert("로그아웃 성공" + Kakao.Auth.getAccessToken())
                                })
                            }
                        });
                    },
                    fail : function(err){
                        alert(JSON.stringify(err))
                    },
                });
            }


            // 로그아웃 //
            function kakaoLogout() {
                console.log("확인1")
                if (!Kakao.Auth.getAccessToken()) {
                    console.log('Not logged in.');
                    return;
                }
                
                Kakao.Auth.logout(function(response) {
                    alert(response +' logout');
                    //window.location.href='/'
                });
            };
            

            // 연결 끊기 //
            function disconnect() {
                console.log("확인2")
                Kakao.API.request({
                    url: '/v1/user/unlink',
                    success: function(response) {
                        console.log(response);
                        //callback(); //연결끊기(탈퇴)성공시 서버에서 처리할 함수
                        //window.location.href='/'
                    },
                    fail: function(error) {
                        console.log('탈퇴 미완료')
                        console.log(error);
                    },
                });
            };


            // DB 조회 //
            function sendLoggedInData(username, email){
                alert("[" + username + "] 님의 이메일 " + email);
            }
        </script>
    </body>
</html>